name: Despliegue Terragrunt Automático

on:
  repository_dispatch:
    types: [deploy-resource-group]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Clonar código
        uses: actions/checkout@v4

      - name: Mostrar versión recibida
        run: |
          echo "Versión recibida: ${{ github.event.client_payload.version }}"



      - name: Reemplazar versión en terragrunt.hcl
        run: |
          sed -i 's|ref=resource_group-v.*|ref=${{ github.event.client_payload.version }}|' \
            terragrunt/infrastructure/resource_group/terragrunt.hcl

      - name: Instalar Terraform y Terragrunt
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip
          curl -sLo terraform.zip https://releases.hashicorp.com/terraform/1.6.6/terraform_1.6.6_linux_amd64.zip
          unzip terraform.zip
          sudo mv terraform /usr/local/bin/
          curl -sLo terragrunt https://github.com/gruntwork-io/terragrunt/releases/latest/download/terragrunt_linux_amd64
          chmod +x terragrunt
          sudo mv terragrunt /usr/local/bin/

      - name: Terragrunt Init
        working-directory: terragrunt/infrastructure/resource_group
        run: terragrunt init

      - name: Terragrunt Plan
        working-directory: terragrunt/infrastructure/resource_group
        run: terragrunt plan
